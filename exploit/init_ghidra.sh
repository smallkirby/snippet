#!/bin/bash

usage(){
  echo "USAGE:"
  echo "  $0 <project name> <binary name> ( -p <project path> -o -l -h -c )"
  echo ""
  echo "OPTIONS:"
  echo "-p, --path: Specify directory in which project is created. If not specified, current working directory is used as default."
  echo "-o: Open Ghidra after initiation of project."
  echo "-l, --log: Output logfile when analysis."
  echo "-c: Run custom analyzer and check common perspectives."
  echo "-h, --help: Show Usage."
}

OPEN_AS_IT=false
COMMON_ENABLE=false
LOG_ENABLE=false
# use Ghidrav v9.2.2+. v9.2.0...v9.2.2 ignores -sciprtPath option
SCRIPT_PATH=$HOME/snipet/exploit/

while [ $# -gt 0 ]
do
  key="$1"

  case $key in
    -h|--help)
      usage
      exit
      ;;
    -p|--path)
      PROJECT_PATH="$2"
      shift
      shift
      ;;
    -o)
      OPEN_AS_IT=true
      shift
      ;;
    -c)
      COMMON_ENABLE=true
      shift
      ;;
    -l|--log)
      LOG_ENABLE=true
      shift
      ;;
    *)
      if [ -z "$PROJECT_NAME" ]
      then
        PROJECT_NAME="$1"
      elif [ -z "$BINARY_NAME" ]
      then
        BINARY_NAME="$1"
      else
        echo "Too much arguments."
        usage
        exit
      fi

      shift
      ;;
esac
done

if [ -z "$PROJECT_PATH" ]
then
  echo "[*] Using $(pwd)/test as project path"
  PROJECT_PATH="$(pwd)"
fi

if $LOG_ENABLE
then
  LOGOUTPUT="anylisis_log.txt"
  LOG_ARG="-log $PROJECT_PATH/$LOGOUTPUT"
  echo "[+] Logging the anylisis at $PROJECT_PATH/$LOGOUTPUT"
else
  LOG_ARG=""
fi

if $COMMON_ENABLE
then
  # DO NOT include path. include only filename
  COMMON_ARG="-postScript $HOME/snippet/exploit/preanalysis_headless.py"
  echo "[+] Enabled common checks of $COMMON_ARG @ $SCRIPT_PATH"
else
  COMMON_ARG=""
fi

if [ -z "$PROJECT_NAME" ]
then
  usage
elif [ -z "$BINARY_NAME" ]
then
  usage
else
  echo "\n\n[+] Starting initiation of project.\n"
  execcommand="$GHIDRA_INSTALL_DIR/support/analyzeHeadless $PROJECT_PATH $PROJECT_NAME -import $BINARY_NAME $LOG_ARG  -scriptPath $SCRIPT_PATH $COMMON_ARG"
  echo "[+] $execcommand"
  eval $execcommand
  echo "\n\n[+] Created project $PROJECT_PATH/$PROJECT_NAME and imported $BINARY_NAME"

  if $OPEN_AS_IT
  then
    echo "[+] Opening Ghidra..."
    sh $GHIDRA_INSTALL_DIR/ghidraRun $PROJECT_PATH/$PROJECT_NAME.gpr
  fi
fi
